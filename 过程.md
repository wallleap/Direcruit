## 准备

Node、MongoDB已经安装且运行



## 创建前端项目direcruit

1、安装脚手架

```bash
npm install -g create-react-app
```



2、脚手架创建项目

```bash
create-react-app direcruit
```



编码测试

```bash
npm start
```



打包发布

```bash
npm run build
npm install -g serve
serve build
```



## 创建目录

删除src中所有文件

目录结构

![目录结构](https://cdn.jsdelivr.net/gh/wallleap/cdn/img/pic/illustration/image-20200716100247638.png)





## UI库下载测试

### 下载，引入点击延迟代码

下载组件库包antd-mobile

```bash
npm install antd-mobile --save
```



在`public/index.html`中修改、添加代码

```html
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no" />

<script src="https://as.alipayobjects.com/g/component/fastclick/1.0.6/fastclick.js"></script> // 点击延迟
<script>
  if ('addEventListener' in document) {
    document.addEventListener('DOMContentLoaded', function() {
      FastClick.attach(document.body);
    }, false);
  }
  if(!window.Promise) {
    document.writeln('<script src="https://as.alipayobjects.com/g/component/es6-promise/3.2.2/es6-promise.min.js"'+'>'+'<'+'/'+'script>');
  }
</script>
```



### 组件按需打包

下载依赖模块

```bash
npm install customize-cra babel-plugin-import react-app-rewired --save-dev
```

定义加载配置的js模块：config-overriders.js

```javascript
const { override, fixBabelImports } = require('customize-cra');
module.exports = override(
  fixBabelImports('import', {
    libraryName: 'antd-mobile',
    style: 'css',
  }),
);
```

修改package.json

```json
  "scripts": {
    "start": "react-app-rewired start",
    "build": "react-app-rewired build",
    "test": "react-app-rewired test --env=jsdom",
    "eject": "react-scripts eject",
    "client": "serve build"
  },
```

测试antd组件`src/index.js`

```javascript
// 入口js
import React from 'react'
import ReactDOM from 'react-dom'
import {Button} from 'antd-mobile'

ReactDOM.render(<Button type="primary">Test</Button>)
```





### 自定义主题

下载依赖模块

```bash
npm install --save-dev babel-plugin-import less@3.10.3 less-loader@5.0.0 style-loader css-loader@3.2.1
```

方便配置颜色，新建antd-theme.json

```json
{
  "@brand-primary": "#108ee9",
  "@brand-primary-tap": "#0e80d2"
}
```

配置config-overriders.js 

```javascript
const { override, fixBabelImports, addLessLoader  } = require('customize-cra');
const theme = require('./antd-theme');

module.exports = override(
  addLessLoader({
    javascriptEnabled: true,
    modifyVars: theme,
  }),
  fixBabelImports('import', {
    libraryName: 'antd-mobile',
    libraryDirectory: 'es',
    style: 'css',
  }),
);
```

所有样式都在这：https://github.com/ant-design/ant-design-mobile/blob/master/components/style/themes/default.less



### 测试按钮

src/index.js

```javascript
// 入口js
import React from 'react'
import ReactDOM from 'react-dom'
import {Button} from 'antd-mobile'

ReactDOM.render(<Button type="primary">Test</Button>, document.getElementById('root'))
```







## 前端路由

下载路由包：

```bash
npm install --save react-router-dom
```



### 注册组件 `src/containers/register/register.jsx`

```jsx
/*
  注册路由组件
*/

import React, { Component } from 'react';

export default class Register extends Component {
  render() {
    return (
      <div>
        Register
      </div>
    )
  }
}
```



### 登录 `src/containers/login/login.jsx`

```
/*
  登录路由组件
*/

import React, { Component } from 'react';

export default class Login extends Component {
  render() {
    return (
      <div>
        Login
      </div>
    )
  }
}
```



### 主界面 `src/containers/main/main.jsx`

```jsx
/*
  主界面路由组件
*/

import React, { Component } from 'react';

export default class Main extends Component {
  render() {
    return (
      <div>
        Main
      </div>
    )
  }
}
```



### 一级路由，到index.js中进行映射

```javascript
// 入口js
import React from 'react'
import ReactDOM from 'react-dom'
// import {Button} from 'antd-mobile'
import {HashRouter, Route, Switch} from 'react-router-dom'
import Register from './containers/register/register'
import Login from './containers/login/login'
import Main from './containers/main/main'

ReactDOM.render(
  <HashRouter>
    <Switch>
      <Route path='/register' component={Register}></Route>
      <Route path='/login' component={Login}></Route>
      <Route component={Main}></Route> {/* 默认组件 */}
    </Switch>
  </HashRouter>
  , document.getElementById('root')
)
```





## 引入redux

### 下载相关依赖包

```bash
npm install --save redux@3.7.2 react-redux redux-thunk
npm install --save-dev redux-devtools-extension
```



### `src/redux/reducers.js`

```javascript
/* 
包含n个reducer函数：根据老的state和指定的action返回一个新的state
*/
import {combineReducers} from 'redux'
function xxx(state=0, action){

  return state
}

function yyy(state=0, action){

  return state
}

export default combineReducers({
  xxx,
  yyy
})
// 向外暴露的状态的结构： {xxx: 0, yyy: 0}
```



### `src/redux/store.js`

```javascript
/* 
redux最核心的管理对象模块
*/
import {createStore, applyMiddleware} from 'redux'
import thunk from 'redux-thunk'
import {composeWithDevTools} from 'redux-devtools-extension'

import reducers from './reducers'

// 向外暴露store对象
export default createStore(reducers, composeWithDevTools(applyMiddleware(thunk)))
```

以后这个就不需要修改了



`src/index.js`

```javascript
// 入口js
import React from 'react'
import ReactDOM from 'react-dom'
// import {Button} from 'antd-mobile'
import {HashRouter, Route, Switch} from 'react-router-dom'
import {Provider} from 'react-redux'

import store from './redux/store'
import Register from './containers/register/register'
import Login from './containers/login/login'
import Main from './containers/main/main'

ReactDOM.render((
  <Provider store={store}>
    <HashRouter>
      <Switch>
        <Route path='/register' component={Register}></Route>
        <Route path='/login' component={Login}></Route>
        <Route component={Main}></Route> {/* 默认组件 */}
      </Switch>
    </HashRouter>
  </Provider>
), document.getElementById('root'))

```





## 登录/注册界面

### 共同logo组件

`components/logo.jsx`

```jsx
/*
登录/注册界面的Logo
*/
import React from 'react'

import logo from './logo.png'
import './logo.less'

export default function Logo(){
  return(
    <div className="logo-container">
      <img src={logo} alt="logo" className="logo-img"/>
    </div>
  )
}
```



`components/logo.less`

```jsx
.logo-container{
  text-align: center;
  .logo-img{
    width: 240px;
    height: 240px;
    border-radius: 50%;
    background-color: #108ee9;
    margin: 20px 0;
  }
}
```

并且将logo.png放入到components文件夹中



### 注册 `src/containers/register/register.jsx`

```jsx
/*
  注册路由组件
*/

import React, { Component } from 'react';
import {
  NavBar,
  WingBlank,
  List,
  InputItem,
  WhiteSpace,
  Radio,
  Button
} from 'antd-mobile'

import Logo from '../../components/logo/logo'

const ListItem = List.Item

export default class Register extends Component {
  state = {
    username: '', // 用户名
    password: '', // 密码
    repassword: '', // 确认密码
    usertype: 'jobhunter', // 用户类型 jobhunter/boss
  }

  register = () => {
    console.log(this.state);
  }

  // 处理输入数据的改变：更新对应的状态
  handleChange = (name, val) => {
    // 更新状态
    this.setState({
      [name]: val // 属性名不是name，而是name变量的值，这里[]并不是数组
    })
  }

  toLogin = () => {
    this.props.history.replace('./login')
  }

  render() {
    const {usertype} = this.state
    return (
      <div>
        <NavBar>某&nbsp;某&nbsp;直&nbsp;聘</NavBar>
        <Logo />
        <WingBlank>
          <List>
            <InputItem placeholder='请输入用户名' onChange={val => {this.handleChange('username', val)}}>用户名 : </InputItem>
            <WhiteSpace />
            <InputItem placeholder='请输入密码' type="password" onChange={val => {this.handleChange('password', val)}}>密&nbsp;&nbsp;&nbsp;码 : </InputItem>
            <WhiteSpace />
            <InputItem placeholder='请再次输入密码' type="password" onChange={val => {this.handleChange('repassword', val)}}>确认密码 : </InputItem>
            <WhiteSpace />
            <ListItem>
              <span>用户类型 : </span>
              &nbsp;&nbsp;&nbsp;
              <Radio checked={usertype==='jobhunter'} onChange={() => this.handleChange('usertype', 'jobhunter')}>求职者</Radio>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              <Radio checked={usertype==='boss'} onChange={() => this.handleChange('usertype', 'boss')}>老板</Radio>
            </ListItem>
            <WhiteSpace />
            <Button type="primary" onClick={this.register}>注册</Button>
            <WhiteSpace />
            <Button onClick={this.toLogin}>已有账户</Button>
          </List>
        </WingBlank>
      </div>
    )
  }
}
```







### 登录`src/containers/login/login.jsx`

```jsx
/*
  登录路由组件
*/

import React, { Component } from 'react';
import {
  NavBar,
  WingBlank,
  List,
  InputItem,
  WhiteSpace,
  Button
} from 'antd-mobile'

import Logo from '../../components/logo/logo'

const ListItem = List.Item

export default class Login extends Component {
  state = {
    username: '', // 用户名
    password: '', // 密码
  }

  login = () => {
    console.log(this.state);
  }

  // 处理输入数据的改变：更新对应的状态
  handleChange = (name, val) => {
    // 更新状态
    this.setState({
      [name]: val // 属性名不是name，而是name变量的值，这里[]并不是数组
    })
  }

  toRegister = () => {
    this.props.history.replace('./register')
  }

  render() {
    return (
      <div>
        <NavBar>某&nbsp;某&nbsp;直&nbsp;聘</NavBar>
        <Logo />
        <WingBlank>
          <List>
            <InputItem placeholder='请输入用户名' onChange={val => {this.handleChange('username', val)}}>用户名 : </InputItem>
            <WhiteSpace />
            <InputItem placeholder='请输入密码' type="password" onChange={val => {this.handleChange('password', val)}}>密&nbsp;&nbsp;&nbsp;码 : </InputItem>
            <WhiteSpace />
            <Button type="primary" onClick={this.login}>登录</Button>
            <WhiteSpace />
            <Button onClick={this.toRegister}>未注册账户</Button>
          </List>
        </WingBlank>
      </div>
    )
  }
}
```





## 搭建后台应用direcruit-server

### 创建node+express应用

利用webstorm创建

![创建后台项目](https://cdn.jsdelivr.net/gh/wallleap/cdn/img/pic/illustration/image-20200716163506124.png)

需要暂时修改两个文件

![server](https://cdn.jsdelivr.net/gh/wallleap/cdn/img/pic/illustration/image-20200716164530516.png)

`bin/www`

```
var port = normalizePort(process.env.PORT || '5000');
```



`routes/index.js`

```javascript
var express = require('express');
var router = express.Router();

/* GET home page. */
/* 注册路由 get请求 path为'/' (后台)渲染index，传了title变量 */
router.get('/', function(req, res, next) {
  res.render('index', { title: 'Express' });
});

// 注册一个路由：用户注册
/*
提供一个用户注册的接口
a) path 为: /register
b) 请求方式为: POST
c) 接收 username 和 password 参数
d) admin 是已注册用户
e) 注册成功返回: {code: 0, data: {_id: 'abc', username: ‘xxx’, password:’123’}}
f) 注册失败返回: {code: 1, msg: '此用户已存在'}
*/
/*
 *(回调函数：处理请求、返回响应)
 * 1、获取请求参数
post请求放在body
get请求放在query
 * 2、处理
 * 3、返回响应数据
 */
router.post('/register', function (req, res) {
  // 1、获取请求参数
  const {username, password} = req.body
  // 2、处理
  if(username==='admin'){ // 注册会失败
    // 3、返回响应数据(失败)
    res.send({code: 1, msg: '此用户已存在'})
  } else{ // 注册会成功
    // 3、返回响应数据(成功)
    res.send({code: 0, data: {_id: 'abc', username, password}})
  }
})

module.exports = router;
```



使用软件Postman测试

至少两组数据

`{username: 'aaa', password: '123456'}`

`{username: 'admin', password: '123456'}`

![postman](https://cdn.jsdelivr.net/gh/wallleap/cdn/img/pic/illustration/image-20200716172036750.png)

Postman中不同post提交方式：https://blog.csdn.net/ye1992/article/details/49998511



###  后台应用自动重运行

1) 问题: 每次修改后台应用代码, 需要重新运行命令修改才生效
2) 解决: 使用 nodemon 包
3) 下载: `npm install --save-dev nodemon`
4) package.json中配置: `"start": "nodemon ./bin/www" `

5) 测试: 修改后台任何代码, 会自动重新运行最新的代码 (按下 ctrl + S)



## 使用mongoose操作数据库

### 下载依赖包

```
npm install --save mongoose blueimp-md5
```



### 测试CRUD `direcruid-server/db/db_test.js`

```javascript
md5
数据库连接
增查改删
```



## 注册/登录后台处理

###  数据库操作模块 `db/models.js`

```javascript
/*
* 包含n个操作数据库集合数据的Model模块
* 用户
* 聊天
1. 连接数据库
1.1. 引入 mongoose
1.2. 连接指定数据库(URL 只有数据库是变化的)
1.3. 获取连接对象
1.4. 绑定连接完成的监听(用来提示连接成功)
2. 定义出对应特定集合的 Model 并向外暴露
2.1. 字义 Schema(描述文档结构)
2.2. 定义 Model(与集合对应, 可以操作集合)
2.3. 向外暴露 Model
*/
/* 1. 连接数据库 */
// 1.1. 引入 mongoose
const mongoose = require(mongoose)
// 1.2. 连接指定数据库(URL 只有数据库是变化的)
mongoose.connect('mongodb://localhost:27017/direcruit')
// 1.3. 获取连接对象
const conn = mongoose.connection
// 1.4. 绑定连接完成的监听(用来提示连接成功)
conn.on('connected', () => {
  console.log('connect success!')
})

/* 2. 定义出对应特定集合的 Model 并向外暴露 */
// 2.1. 字义 Schema(描述文档结构)
const userSchema = mongoose.Schema({
  username: {type: String, required: true}, //用户名
  password: {type: String, required: true}, //密码
  usertype: {type: String, required: true}, //用户类型：jobhunter/boss
  avatar: {type: String}, //头像名称
  post: {type: String}, //职位
  info: {type: String}, //个人或职位简介
  company: {type: String}, //公司名称
  salary: {type: String} //月薪
})
// 2.2. 定义 Model(与集合对应, 可以操作集合)
const UserModel = mongoose.model('user', userSchema)
// 2.3. 向外暴露 Model
exports.UserModel = UserModel
// module.exports = xxx 一次性暴露,   exports.xxx = value 分别暴露
```



### 路由模块 `routes/index.js`

```javascript
var express = require('express');
var router = express.Router();
const md5 = require('blueimp-md5')
// const UserModel = require('../db/models').UserModel
const {UserModel} = require('../db/models') // 解构赋值
const filter = {password: 0, _v: 0} // 指定过滤password、_v属性
/* 注册的路由 */
router.post('/register', function (req, res) {
  // 1、读取请求参数
  const {username, password, usertype} = req.body
  // 2、处理：判断用户是否已经存在，如果存在，返回提示错误的信息，如果不存在，保存
  // 查询
  UserModel.findOne({username}, function(err, user){
    if(user){ // 如果user有值(已存在)
      // 3、返回响应数据
      res.send({code: 1, msg: '此用户已存在'})
    }else{ // user没值(不存在)
      new UserModel({username, usertype, password: md5(password)}).save(function (error, user) {
        // 生成一个 cookie(userid: user._id), 并交给浏览器保存
        res.cookie('userid', user._id, {maxAge: 1000*60*60*24*7}) // 持久化 cookie, 浏览器会保存在本地文件
        // 返回包含user的json数据
        const data = {username, usertype, _id: user._id} // 响应数据中不要携带password
        // 3、返回响应数据
        res.send({code: 0, data})
      })
    }
  })
})

/* 登录的路由 */
router.post('/login', function (req, res) {
  const {username, password} = req.body
  // 根据username和password查询数据库users，如果没有，返回提示错误的信息，如果有，返回登录成功信息(包含user)
  UserModel.findOne({username}, filter,function (err, user) { // 过滤了密码
    if(user){
      UserModel.findOne({username, password: md5(password)}, filter, function (err, user) { // 过滤了密码
        if (user) { // 登录成功
          // 生成一个 cookie(userid: user._id), 并交给浏览器保存
          res.cookie('userid', user._id, {maxAge: 1000 * 60 * 60 * 24 * 7})
          // 返回成功的信息(包含user)
          res.send({code: 0, data: user})
        } else { // 登录失败
          res.send({code: 1, msg: '密码不正确！'})
        }
      })
    }else{
      res.send({code: 1, msg: '用户不存在！'})
    }
  })
})

module.exports = router;

```



## 注册/登录前台处理

### 封装 ajax 请求代码

- 下载相关依赖包

```bash
npm install --save axios
```



- `api/ajax.js`

```javascript
/*
能发送ajax请求得函数模块
函数的返回值为promise对象
*/
import axios from 'axios'

// 暴露函数ajax，参数有url，数据对象(默认值为空对象)，方式(默认为GET)
export default function ajax(url, data={}, method='GET'){
  /*两种方式：GET(url后面带参数)、POST(url和数据)
  axios.get(url)
  axios.post(url,data)
  */
  if(method==='GET'){ // 发送GET请求
    // GET需要把data请求参数拼到url中
    // eg: paramStr = username=Bob&password=123456
    let paramStr = ''
    Object.keys(data).forEach(key => [ // 得到data对象所有key的数组，进行遍历
      paramStr += key + '=' +data[key] + '&'
    ])
    if(paramStr){
      paramStr = paramStr.substring(0, paramStr.length-1) // 去掉最后的&
    }
    url = url + '?' +paramStr
    // 使用axios发get请求
    return axios.get(url)
  }else{ // 发送POST请求
    // 使用axios发post请求
    return axios.post(url, data)
  }
}
```



- `api/index.js`

```javascript
/*
包含n个接口请求得函数模块
函数返回值为： promise
*/
import ajax from 'ajax'

// 注册接口
export const reqRegister = (user) => ajax('/register', user, 'POST')
// 登录接口
export const reqLogin = ({username, password}) => ajax('/login', {username, password}, 'POST')
// 更新用户信息接口
export const reqUpdateUser = (user) => ajax('/update', user, 'POST')
```



### 使用 redux 管理用户信息



- `src/redux/action-types.js`

```javascript
/*
包含n个action type名称常量
*/
export const AUTH_SUCCESS = 'auth_success'  // 注册/登录成功
export const ERROR_MSG = 'error_msg'  // 错误提示信息 请求前/请求后
```



- `src/redux/actions.js`

```javascript
/* 
包含n个action creator
同步action
异步action
*/
import {
  AUTH_SUCCESS,
  ERROR_MSG
} from './action-types'
// 引入接口请求函数
import {
  reqRegister,
  reqLogin
} from '../api'

// 授权成功的同步action
const authSuccess = (user) => ({type: AUTH_SUCCESS, data: user})
// 错误提示信息的同步action
const errorMsg = (msg) => ({type: ERROR_MSG, data: msg}) // 或省略data

// 注册异步action
export const register = (user) => {
  const {username, password, repassword, usertype} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }
  if(!repassword){
    return errorMsg('请输入确认密码')
  }
  if(password!==repassword){
    return errorMsg('两次输入的密码不一致，请检查！') 
    // 如果放到dispatch中应该不是return而是dispatch
  }
  // 表单数据合法，返回一个发ajax请求得异步action函数
  return async dispatch => {
    // 发送注册的异步ajax请求
    /*const promise = reqRegister(user) // 应该把repassword去掉
    promise.then(response => {
      const result = response.data // {code: 0/1, data: user, msg: ''}
    })*/
    // await等，这个函数必须声明为async
    const response = await reqRegister({username, password, usertype})
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 登录异步action
export const login = (user) => {
  const {username, password} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }

  return async dispatch => {
    // 发送注册的异步ajax请求
    // await等，这个函数必须声明为async
    const response = await reqLogin(user)
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}
```



- 由于reducers需要判断路径的，因此封装一个功能函数放到 `src/utils/index.js`

```javascript
/**
 * 包含n个工具函数的模块
 */
/*
跳转的
- 用户主界面路由
  - boss：/boss
  - jobhunter：/jobhunter
- 用户信息完善界面路由
  - boss：/bossinfo
  - jobhunter：jobhunterinfo
判断是否已经完善信息：user.avatar是否有值
判断用户类型：user.usertype
*/
// 返回对应的路由路径
export function getRedirectTo(usertype, avatar){
  let path = ''
  // usertype
  if(usertype==='boss'){
    path = '/boss'
  }else{
    path = 'jobhunter'
  }
  // avatar
  if(!avatar){// 没有值，返回信息完善界面的path
    path += 'info'
  }
  return path
}
```



- `src/redux/reducers.js`

```javascript
/* 
包含n个reducer函数：根据老的state和指定的action返回一个新的state
*/
import {combineReducers} from 'redux'
import {
  AUTH_SUCCESS,
  ERROR_MSG
} from './action-types'
import {getRedirectTo} from '../utils/index'

const initUser = {
  username: '', // 用户名
  usertype: '', // 用户类型 jobhunter/boss
  msg: '', // 错误提示信息
  redirectTo: '' // 需要自动重定向的路由路径
}

// 产生user状态的reducer
function user(state=initUser, action){
  switch(action.type){
    case AUTH_SUCCESS: // data是user 应该跳转到某个页面
      const {usertype, avatar} = action.data
      return {...action.data, redirectTo: getRedirectTo(usertype, avatar)}
    case ERROR_MSG: // data是msg
      return {...state, msg: action.data}
    default:
      return state
  }
}

export default combineReducers({
  user
})
// 向外暴露的状态的结构： {user: {}}
```



跨域请求解决

- JSONP：只支持GET请求
- CORS非简单请求（也称预检请求）：改服务器
- 技巧：代理proxy

在`src/package.json`中添加

```json
  "proxy": "http://localhost:5000"
```





### 将UI组件包装成容器组件

- 注册组件 `src/containers/register/register.jsx`

```jsx
/*
  注册路由组件
*/

import React, { Component } from 'react';
import {
  NavBar,
  WingBlank,
  List,
  InputItem,
  WhiteSpace,
  Radio,
  Button
} from 'antd-mobile'
import {connect} from 'react-redux'
import {Redirect} from 'react-router-dom'

import {register} from '../../redux/actions'
import Logo from '../../components/logo/logo'

const ListItem = List.Item

class Register extends Component {
  state = {
    username: '', // 用户名
    password: '', // 密码
    repassword: '', // 确认密码
    usertype: 'jobhunter', // 用户类型 jobhunter/boss
  }

  // 点击注册调用
  register = () => {
    // console.log(this.state);
    this.props.register(this.state)
  }

  // 处理输入数据的改变：更新对应的状态
  handleChange = (name, val) => {
    // 更新状态
    this.setState({
      [name]: val // 属性名不是name，而是name变量的值，这里[]并不是数组
    })
  }

  toLogin = () => {
    this.props.history.replace('./login')
  }

  render() {
    const {usertype} = this.state
    const {msg, redirectTo} = this.props.user
    // 如果redirectTo有值(注册/登录成功)，就要重定向到指定的路由
    if(redirectTo){
      return <Redirect to={redirectTo} />
    }
    return (
      <div>
        <NavBar>某&nbsp;某&nbsp;直&nbsp;聘</NavBar>
        <Logo />
        <WingBlank>
          <List>
            {msg ? <div className='error-msg'>{msg}</div> : null}
            <InputItem placeholder='请输入用户名' onChange={val => {this.handleChange('username', val)}}>用户名 : </InputItem>
            <WhiteSpace />
            <InputItem placeholder='请输入密码' type="password" onChange={val => {this.handleChange('password', val)}}>密&nbsp;&nbsp;&nbsp;码 : </InputItem>
            <WhiteSpace />
            <InputItem placeholder='请再次输入密码' type="password" onChange={val => {this.handleChange('repassword', val)}}>确认密码 : </InputItem>
            <WhiteSpace />
            <ListItem>
              <span>用户类型 : </span>
              &nbsp;&nbsp;&nbsp;
              <Radio checked={usertype==='jobhunter'} onChange={() => this.handleChange('usertype', 'jobhunter')}>求职者</Radio>
              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
              <Radio checked={usertype==='boss'} onChange={() => this.handleChange('usertype', 'boss')}>老板</Radio>
            </ListItem>
            <WhiteSpace />
            <Button type="primary" onClick={this.register}>注册</Button>
            <WhiteSpace />
            <Button onClick={this.toLogin}>已有账户</Button>
          </List>
        </WingBlank>
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user}),
  {register}
)(Register)
```



- 登录组件 `src/containers/login/login.jsx`

```jsx
/*
  登录路由组件
*/

import React, { Component } from 'react';
import {
  NavBar,
  WingBlank,
  List,
  InputItem,
  WhiteSpace,
  Button
} from 'antd-mobile'
import {connect} from 'react-redux'
import {Redirect} from 'react-router-dom'

import {login} from '../../redux/actions'
import Logo from '../../components/logo/logo'

const ListItem = List.Item

class Login extends Component {
  state = {
    username: '', // 用户名
    password: '', // 密码
  }

  login = () => {
    // console.log(this.state);
    this.props.login(this.state)
  }

  // 处理输入数据的改变：更新对应的状态
  handleChange = (name, val) => {
    // 更新状态
    this.setState({
      [name]: val // 属性名不是name，而是name变量的值，这里[]并不是数组
    })
  }

  toRegister = () => {
    this.props.history.replace('./register')
  }

  render() {
    const {msg, redirectTo} = this.props.user
    // 如果redirectTo有值(注册/登录成功)，就要重定向到指定的路由
    if(redirectTo){
      return <Redirect to={redirectTo} />
    }
    return (
      <div>
        <NavBar>某&nbsp;某&nbsp;直&nbsp;聘</NavBar>
        <Logo />
        <WingBlank>
          <List>
            {msg ? <div className='error-msg'>{msg}</div> : null}
            <InputItem placeholder='请输入用户名' onChange={val => {this.handleChange('username', val)}}>用户名 : </InputItem>
            <WhiteSpace />
            <InputItem placeholder='请输入密码' type="password" onChange={val => {this.handleChange('password', val)}}>密&nbsp;&nbsp;&nbsp;码 : </InputItem>
            <WhiteSpace />
            <Button type="primary" onClick={this.login}>登录</Button>
            <WhiteSpace />
            <Button onClick={this.toRegister}>未注册账户</Button>
          </List>
        </WingBlank>
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user}),
  {login}
)(Login)
```



由于添加了一个div，需要样式，因此新建`src/assets/css/index.less`

```less
.error-msg{
  color: red;
  text-align: center;
  font-size: 1.125rem;
}
```



在`src/index.js`中导入

```javascript
import './assets/css/index.less'
```



## 实现用户信息完善功能



- 选择头像的组件 `src/components/avatar-selector/avatar-selector.jsx`

由于用到proptypes，因此先安装

```bash
npm install --save prop-types
```



```jsx
/*
选择用户头像的UI组件
*/

import React, { Component } from 'react';
import {
  List,
  Grid
} from 'antd-mobile'
import PropTypes from 'prop-types'

export default class AvatarSelector extends Component {
  static propTypes = {
    setAvatar: PropTypes.func.isRequired

  }

  state = {
    icon: null // 图片对象，默认没有值
  }

  constructor(props){
    super(props)
    // 准备需要显示的数据
    this.avatars = []
    for (let i = 0; i < 20; i++) {
      this.avatars.push({
        text: '头像'+(i+1),
        icon: require(`../../assets/images/头像${i+1}.png`) // 不能用import
      })
    }
  }

  handleClick = ({text, icon}) => {
    // 更新当前组件状态
    this.setState({icon})
    // 调用函数更新父组件状态
    this.props.setAvatar(text)
  }

  render() {
    // 列表头部文本
    const {icon} = this.state
    const listHeader = !this.state.icon ? "请选择头像" : (
      <div className="avatar-selected">
        已选择头像: <img src={icon} alt="头像"/>
      </div>
    )

    return (
      <List renderHeader={() => listHeader}>
        <Grid data={this.avatars} 
              columnNum={5}
              onClick={this.handleClick}
        />
      </List>
    )
  }
}
```





- 老板信息完善路由容器组件 `src/containers/bossinfo/bossinfo.jsx`

```jsx
/*
老板信息完善的路由容器组件
*/
import React, { Component } from 'react'
import {connect} from 'react-redux'
import {Redirect} from 'react-router-dom'
import {
  NavBar,
  InputItem,
  TextareaItem,
  WhiteSpace,
  Button
} from 'antd-mobile'

import AvatarSelector from '../../components/avatar-selector/avatar-selector'
import {updateUser} from '../../redux/actions'

class BossInfo extends Component {

  state = {
    avatar: '', //头像名称
    post: '', //职位
    info: '', //个人或职位简介
    company: '', //公司名称
    salary: '' //月薪
  }

  // 更新avatar状态
  setAvatar = (avatar) => {
    this.setState({
      avatar
    })
  }

  handleChange = (name, value) => {
    this.setState({
      [name]: value  // 取得是name的值
    })
  }

  save = () => {
    // console.log(this.state)
    this.props.updateUser(this.state)
  }

  render() {
    const {avatar, usertype} = this.props.user
    if(avatar){ // 有值，用户信息已完善，应该重定向到相应主页面
      const path = usertype==='boss' ? '/boss' : '/jobhunter'
      return <Redirect to={path}/>
    }

    return (
      <div>
        <NavBar>老板信息完善</NavBar>
        <AvatarSelector setAvatar={this.setAvatar} />
        <WhiteSpace/>
        <InputItem onChange={val => {this.handleChange('post', val)}} placeholder="请输入招聘职位">招聘职位:</InputItem>
        <InputItem onChange={val => {this.handleChange('company', val)}} placeholder="请输入公司名称">公司名称:</InputItem>
        <InputItem onChange={val => {this.handleChange('salary', val)}} placeholder="请输入职位薪资">职位薪资:</InputItem>
        <TextareaItem onChange={val => {this.handleChange('info', val)}} title="职位要求:" 
                      rows={3}
                      placeholder="请输入职位要求"
        />
        <Button onClick={this.save} type="primary">保&nbsp;&nbsp;&nbsp;存</Button>
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user}),
  {updateUser}
)(BossInfo)
```



- 求职者信息完善路由容器组件 `src/containers/jobhunterinfo/jobhunterinfo.jsx`

```jsx
/*
求职者信息完善的路由容器组件
*/
import React, { Component } from 'react'
import {connect} from 'react-redux'
import {Redirect} from 'react-router-dom'
import {
  NavBar,
  InputItem,
  TextareaItem,
  WhiteSpace,
  Button
} from 'antd-mobile'

import AvatarSelector from '../../components/avatar-selector/avatar-selector'
import {updateUser} from '../../redux/actions'

class JobhunterInfo extends Component {
  
  state = {
    avatar: '', //头像名称
    post: '', //职位
    info: '', //个人或职位简介
  }

  // 更新avatar状态
  setAvatar = (avatar) => {
    this.setState({
      avatar
    })
  }

  handleChange = (name, value) => {
    this.setState({
      [name]: value  // 取得是name的值
    })
  }

  save = () => {
    // console.log(this.state)
    this.props.updateUser(this.state)
  }

  render() {
    const {avatar, usertype} = this.props.user
    if(avatar){ // 有值，用户信息已完善，应该重定向到相应主页面
      const path = usertype==='boss' ? '/boss' : '/jobhunter'
      return <Redirect to={path}/>
    }

    return (
      <div>
        <NavBar>求职者信息完善</NavBar>
        <AvatarSelector setAvatar={this.setAvatar} />
        <WhiteSpace/>
        <InputItem onChange={val => {this.handleChange('post', val)}} placeholder="请输入求职岗位">求职岗位:</InputItem>
        <TextareaItem onChange={val => {this.handleChange('info', val)}} title="个人介绍:" 
                      rows={3}
                      placeholder="请输入个人介绍"
        />
        <Button onClick={this.save} type="primary">保&nbsp;&nbsp;&nbsp;存</Button>
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user}),
  {updateUser}
)(JobhunterInfo)
```



- 主页面容器中引入路由组件 `src/containers/main/main.jsx`

```jsx
/*
  主界面路由组件
*/

import React, { Component } from 'react';
import {connect} from 'react-redux'
import {Switch, Route, Redirect} from 'react-router-dom'

import BossInfo from '../bossinfo/bossinfo'
import JobhunterInfo from '../jobhunterinfo/jobhunterinfo'

class Main extends Component {
  render() {
    // 检查用户是否登录，如果没有，自动重定向到登录界面
    const {user} = this.props
    if(!user._id){
      return <Redirect to='/login' />
    }
    return (
      <div>
        <Switch>
          <Route path='/bossinfo' component={BossInfo}></Route>
          <Route path='/jobhunterinfo' component={JobhunterInfo}></Route>
        </Switch>
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user})
)(Main)
```



## 搭建整体界面

### 后台

- 后台路由: `routes/index.js`中添加更新用户信息的路由

```javascript
// 更新用户信息的路由
router.post('/update',function (req,res) {
  // 先从请求得cookie中得到userid
  const userid = req.cookies.userid // cookies是对象
  if(!userid){ // 如果不存在，直接返回提示信息，并结束
    return res.send({code: 1, msg: '请先登录'})
  }
  // 根据userid更新对应的user文档数据
  // 得到提交的用户数据
  const user = req.body // 提交过来的user，没有_id
  UserModel.findByIdAndUpdate({_id:userid}, user, function (error, oldUser) {
    if(!oldUser){ // 数据库中不能找到，因此通知浏览器删除userid cookie
      res.clearCookie('userid')
      // 返回提示信息
      res.send({code: 1, msg: '请先登录'})
    }else {
      const {_id, username, usertype} = oldUser // 从oldUer中取出
      const data = Object.assign(user, {_id, username, usertype}) // 合并数据，assign可以合并多个对象数据
      res.send({code: 0, data})
    }
  })
})
```



### 前台

- .ajax 请求模块: `src/api/index.js`

已经写了

```javascript
// 更新用户信息接口
export const reqUpdateUser = (user) => ajax('/update', user, 'POST')
```



- redux 管理状态 

`src/redux/action-types.js`

```javascript
/*
包含n个action type名称常量
*/
export const AUTH_SUCCESS = 'auth_success'  // 注册/登录成功
export const ERROR_MSG = 'error_msg'  // 错误提示信息 请求前/请求后
export const RECEIVE_USER = 'receive_user' // 接收用户
export const RESET_USER = 'rreset_user' // 重置用户
```



`src/redux/actions.js`

```javascript
/* 
包含n个action creator
同步action
异步action
*/
import {
  AUTH_SUCCESS,
  ERROR_MSG,
  RECEIVE_USER,
  RESET_USER
} from './action-types'
// 引入接口请求函数
import {
  reqRegister,
  reqLogin,
  reqUpdateUser
} from '../api'

// 授权成功的同步action
const authSuccess = (user) => ({type: AUTH_SUCCESS, data: user})
// 错误提示信息的同步action
const errorMsg = (msg) => ({type: ERROR_MSG, data: msg}) // 或省略data
// 接收用户的同步action
const receiveUser = (user) => ({type: RECEIVE_USER, data: user})
// 重置用户的同步action
const resetUser = (msg) => ({type: RESET_USER, data: msg})

// 注册异步action
export const register = (user) => {
  const {username, password, repassword, usertype} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }
  if(!repassword){
    return errorMsg('请输入确认密码')
  }
  if(password!==repassword){
    return errorMsg('两次输入的密码不一致，请检查！') 
    // 如果放到dispatch中应该不是return而是dispatch
  }
  // 表单数据合法，返回一个发ajax请求得异步action函数
  return async dispatch => {
    // 发送注册的异步ajax请求
    /*const promise = reqRegister(user) // 应该把repassword去掉
    promise.then(response => {
      const result = response.data // {code: 0/1, data: user, msg: ''}
    })*/
    // await等，这个函数必须声明为async
    const response = await reqRegister({username, password, usertype})
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 登录异步action
export const login = (user) => {
  const {username, password} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }

  return async dispatch => {
    // 发送注册的异步ajax请求
    // await等，这个函数必须声明为async
    const response = await reqLogin(user)
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 更新用户异步action
export const updateUser = (user) => {
  return async dispath => {
    const response = await reqUpdateUser(user)
    const result = response.data
    if(result.code===0){ // 更新成功：data
      // 分发同步action
      dispath(receiveUser(result.data))
    }else{ // 更新失败：msg
      dispath(resetUser(result.msg))
    }
  }
}
```



`src/redux/reducers.js`

```javascript
/* 
包含n个reducer函数：根据老的state和指定的action返回一个新的state
*/
import {combineReducers} from 'redux'
import {
  AUTH_SUCCESS,
  ERROR_MSG,
  RECEIVE_USER,
  RESET_USER
} from './action-types'
import {getRedirectTo} from '../utils/index'

const initUser = {
  username: '', // 用户名
  usertype: '', // 用户类型 jobhunter/boss
  msg: '', // 错误提示信息
  redirectTo: '' // 需要自动重定向的路由路径
}

// 产生user状态的reducer
function user(state=initUser, action){
  switch(action.type){
    case AUTH_SUCCESS: // data是user 应该跳转到某个页面
      const {usertype, avatar} = action.data
      return {...action.data, redirectTo: getRedirectTo(usertype, avatar)}
    case ERROR_MSG: // data是msg
      return {...state, msg: action.data}
    case RECEIVE_USER: // data是user
      return action.data
    case RESET_USER: // data是msg
      return {...initUser, msg: action.data} // 更新失败(前台数据有问题)
    default:
      return state
  }
}

export default combineReducers({
  user
})
// 向外暴露的状态的结构： {user: {}}
```



## 接着实现user信息完善功能



### 前台

由于需要操作cookie，因此下载依赖包

```bash
npm install --save js-cookie
```



- `src/api/index.js`

```javascript
/*
包含n个接口请求得函数模块
函数返回值为： promise
*/
import ajax from './ajax'

// 注册接口
export const reqRegister = (user) => ajax('/register', user, 'POST')
// 登录接口
export const reqLogin = ({username, password}) => ajax('/login', {username, password}, 'POST')
// 更新用户信息接口
export const reqUpdateUser = (user) => ajax('/update', user, 'POST')
// 获取用户信息
export const reqUser = () => ajax('/user')
```



- `src/redux/actions.js`

```javascript
/* 
包含n个action creator
同步action
异步action
*/
import {
  AUTH_SUCCESS,
  ERROR_MSG,
  RECEIVE_USER,
  RESET_USER
} from './action-types'
// 引入接口请求函数
import {
  reqRegister,
  reqLogin,
  reqUpdateUser,
  reqUser
} from '../api'

// 授权成功的同步action
const authSuccess = (user) => ({type: AUTH_SUCCESS, data: user})
// 错误提示信息的同步action
const errorMsg = (msg) => ({type: ERROR_MSG, data: msg}) // 或省略data
// 接收用户的同步action
const receiveUser = (user) => ({type: RECEIVE_USER, data: user})
// 重置用户的同步action
const resetUser = (msg) => ({type: RESET_USER, data: msg})

// 注册异步action
export const register = (user) => {
  const {username, password, repassword, usertype} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }
  if(!repassword){
    return errorMsg('请输入确认密码')
  }
  if(password!==repassword){
    return errorMsg('两次输入的密码不一致，请检查！') 
    // 如果放到dispatch中应该不是return而是dispatch
  }
  // 表单数据合法，返回一个发ajax请求得异步action函数
  return async dispatch => {
    // 发送注册的异步ajax请求
    /*const promise = reqRegister(user) // 应该把repassword去掉
    promise.then(response => {
      const result = response.data // {code: 0/1, data: user, msg: ''}
    })*/
    // await等，这个函数必须声明为async
    const response = await reqRegister({username, password, usertype})
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 登录异步action
export const login = (user) => {
  const {username, password} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }

  return async dispatch => {
    // 发送注册的异步ajax请求
    // await等，这个函数必须声明为async
    const response = await reqLogin(user)
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 更新用户异步action
export const updateUser = (user) => {
  return async dispath => {
    const response = await reqUpdateUser(user)
    const result = response.data
    if(result.code===0){ // 更新成功：data
      // 分发同步action
      dispath(receiveUser(result.data))
    }else{ // 更新失败：msg
      dispath(resetUser(result.msg))
    }
  }
}

// 获取用户异步action
export const getUser = () => {
  return async dispatch => {
    // 执行异步ajax请求
    const response = await reqUser()
    const result = response.data
    if(result.code===0){// 成功
      dispatch(receiveUser(result.data))
    }else{// 失败
      dispatch(resetUser(result.msg))
    }
  }
}
```



- `src/containers/main/main.jsx`

```jsx
/*
  主界面路由组件
*/

import React, { Component } from 'react';
import {Switch, Route, Redirect} from 'react-router-dom'
import {connect} from 'react-redux'
import Cookies from 'js-cookie' // 可以操作前端cookie的对象 set()/get()/remove()

import BossInfo from '../bossinfo/bossinfo'
import JobhunterInfo from '../jobhunterinfo/jobhunterinfo'
import {getRedirectTo} from '../../utils'
import {getUser} from '../../redux/actions'

class Main extends Component {

  componentDidMount(){
    // 如果登录过(cookie中有userid)，但现在没登录(redux管理的user中没有_id)发送请求获取对应的user
    const userid = Cookies.get('userid')
    const {_id} = this.props.user
    if(userid && !_id){
      // 发送异步请求，获取user
      // console.log('发送ajax请求，获取user');
      this.props.getUser()
    }
  }

  render() {
    /*// 检查用户是否登录，如果没有，自动重定向到登录界面
    const {user} = this.props
    if(!user._id){
      return <Redirect to='/login' />
    }*/
    /*
    1、实现自动登录：
    componentDidMount中：
      1)如果登录过(cookie中有userid)，但现在没登录(redux管理的user中没有_id)发送请求获取对应的user，暂时不做任何显示
    render中：
      2)如果cookie中没有userid，自动进入(重定向)login界面
      3)判断redux管理的user中是否有_id，如果没有，暂时不做任何显示
      4)如果有，说明当前已经登录，显示对应的界面
      5）如果已经登录，且想要请求根路径：根据user的avatar和usertype计算出一个重定向的路由路径，并自动重定向
    */
    // 1读取cookie中的userid
    const userid = Cookies.get('userid')
    // 1.1如果没有，自动重定向到登录界面
    if(!userid){
      return <Redirect to='/login' />
    }
    // 1.2如果有，读取redux中的user状态
    const {user} = this.props
    // 1.2.1如果user没有_id，返回null(不做任何显示)
    // debugger // 打断，调试请求过程
    if(!user._id){
      return null
    }else{
      // 1.2.2如果有_id，显示对应的界面
      // 1.2.3访问根路径，根据user的avatar和usertype计算出一个重定向的路由路径，并自动重定向
      let path = this.props.location.pathname
      if(path==='/'){
        path = getRedirectTo(user.usertype, user.avatar)
        return <Redirect to={path} />
      }
    }
    
    return (
      <div>
        <Switch>
          <Route path='/bossinfo' component={BossInfo}></Route>
          <Route path='/jobhunterinfo' component={JobhunterInfo}></Route>
        </Switch>
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user}),
  {getUser}
)(Main)
```



### 后台

- `routes/index.js`

```javascript
var express = require('express');
var router = express.Router();
const md5 = require('blueimp-md5')
// const UserModel = require('../db/models').UserModel
const {UserModel} = require('../db/models') // 解构赋值
const filter = {password: 0, _v: 0} // 指定过滤password、_v属性

/* 注册的路由 */
router.post('/register', function (req, res) {
  // 1、读取请求参数
  const {username, password, usertype} = req.body
  // 2、处理：判断用户是否已经存在 3、返回响应数据如果存在，返回提示错误的信息，如果不存在，保存
  // 查询
  UserModel.findOne({username}, function(err, user){
    if(user){ // 如果user有值(已存在)
      res.send({code: 1, msg: '此用户已存在'})
    }else{ // user没值(不存在)
      new UserModel({username, usertype, password: md5(password)}).save(function (error, user) {
        // 生成一个 cookie(userid: user._id), 并交给浏览器保存
        res.cookie('userid', user._id, {maxAge: 1000*60*60*24*7}) // 持久化 cookie, 浏览器会保存在本地文件
        // 返回包含user的json数据
        const data = {username, usertype, _id: user._id} // 响应数据中不要携带password
        res.send({code: 0, data})
      })
    }
  })
})

/* 登录的路由 */
router.post('/login', function (req, res) {
  const {username, password} = req.body
  // 根据username和password查询数据库users，如果没有，返回提示错误的信息，如果有，返回登录成功信息(包含user)
  UserModel.findOne({username}, filter,function (err, user) { // 过滤了密码
    if(user){
      UserModel.findOne({username, password: md5(password)}, filter, function (err, user) { // 过滤了密码
        if (user) { // 登录成功
          // 生成一个 cookie(userid: user._id), 并交给浏览器保存
          res.cookie('userid', user._id, {maxAge: 1000 * 60 * 60 * 24 * 7})
          // 返回成功的信息(包含user)
          res.send({code: 0, data: user})
        } else { // 登录失败
          res.send({code: 1, msg: '密码不正确！'})
        }
      })
    }else{
      res.send({code: 1, msg: '用户不存在！'})
    }
  })
})

// 更新用户信息的路由
router.post('/update',function (req,res) {
  // 先从请求得cookie中得到userid
  const userid = req.cookies.userid // cookies是对象
  if(!userid){ // 如果不存在，直接返回提示信息，并结束
    return res.send({code: 1, msg: '请先登录'})
  }
  // 根据userid更新对应的user文档数据
  // 得到提交的用户数据
  const user = req.body // 提交过来的user，没有_id
  UserModel.findByIdAndUpdate({_id:userid}, user, function (error, oldUser) {
    if(!oldUser){ // 数据库中不能找到，因此通知浏览器删除userid cookie
      res.clearCookie('userid')
      // 返回提示信息
      res.send({code: 1, msg: '请先登录'})
    }else {
      const {_id, username, usertype} = oldUser // 从oldUer中取出
      const data = Object.assign(user, {_id, username, usertype}) // 合并数据，assign可以合并多个对象数据
      res.send({code: 0, data})
    }
  })
})

// 获取用户信息的路由(根据cookie中的userid)
router.get('/user', function (req, res) {
  // 先从请求得cookie中得到userid
  const userid = req.cookies.userid
  // 判断
  if(!userid){ // 如果不存在，直接返回提示信息，并结束
    return res.send({code: 1, msg: '请先登录'})
  }
  // 根据userid查询对应的user
  UserModel.findOne({_id: userid}, filter, function (error, user) {
    res.send({code: 0, data: user})
  })
})

module.exports = router;
```



## 实现登录、完善信息后的组件

### main一级路由下的二级路由组件

- Boss主界面`src/containers/boss/boss.jsx`

```jsx
/*
老板主界面路由容器组件
*/
import React, { Component } from 'react'
import {connect} from 'react-redux'

class Boss extends Component {
  render() {
    return (
      <div>
        Boss
      </div>
    )
  }
}

export default connect(
  state => ({}),
  {}
)(Boss)
```



- Jobhunter主界面`src/containers/jobhunter/jobhunter.jsx`

```jsx
/*
求职者主界面路由容器组件
*/
import React, { Component } from 'react'
import {connect} from 'react-redux'

class Jobhunter extends Component {
  render() {
    return (
      <div>
        Jobhunter
      </div>
    )
  }
}

export default connect(
  state => ({}),
  {}
)(Jobhunter)
```



- 消息界面`src/containers/message/message.jsx`

```jsx
/*
消息界面路由容器组件
*/
import React, { Component } from 'react'
import {connect} from 'react-redux'

class Message extends Component {
  render() {
    return (
      <div>
        Message
      </div>
    )
  }
}

export default connect(
  state => ({}),
  {}
)(Message)
```



- 个人中心`src/containers/personal/personal.jsx`

```jsx
/*
个人中心界面路由容器组件
*/
import React, { Component } from 'react'
import {connect} from 'react-redux'
import {Result, List, WhiteSpace, Button, Modal} from 'antd-mobile'
import Cookies from 'js-cookie'
import {resetUser, updateUser} from '../../redux/actions'
import {getRedirectTo} from '../../utils'
import {withRouter} from 'react-router-dom'

const Item = List.Item
const Brief = Item.Brief

class Personal extends Component {

  logout = () => {
    Modal.alert('退出', '确认退出登录吗?', [
      {
        text: '取消',
        onPress: () => console.log('cancel')
      },
      {
        text: '确认',
        onPress: () => {
          // 清除 cookie 中的 userid
          Cookies.remove('userid')
          // 重置 redux 中的 user 状态
          this.props.resetUser()
        }
      }
    ])
  }

  updateInfo = () => {
    const path = getRedirectTo(this.props.user.usertype, 'updateAvatar')
    this.props.history.replace(path)
  }

  render() {
    const {username, usertype, avatar, company, info, post, salary} = this.props.user
    return (
      <div>
        <Result 
          img={<img src={require(`../../assets/images/${avatar}.png`)} style={{width: 50}} alt="avatar"/>}
          title={username}
          message={company}
        />
        <List>
          <Item extra={<Button onClick={this.updateInfo} size="small" inline icon={require('../../assets/imgs/edit.png')}>修改信息</Button>}>相关信息</Item>
          <Item multipleLine>
            <Brief>职位：{post}</Brief>
            <Brief>简介：{info}</Brief>
            {salary ? <Brief>薪资：{salary}</Brief> : null}
          </Item>
        </List>
        <WhiteSpace/>
        <List>
        <Button onClick={this.logout} type='warning'>退出登录</Button>
        </List>
      </div>
    )
  }
}

export default withRouter(
  connect(
    state => ({user: state.user}),
    {resetUser}
  )(Personal)
) 
```



### 提取出的共同组件

- 404`src/components/not-found/not-found.jsx`

```jsx
/*
提示找不到页面的UI路由组件
*/
import React, { Component } from 'react';
import {Button} from 'antd-mobile'

export default class NotFound extends Component {
  render() {
    return (
      <div>
        <h2>抱歉，找不到该页面！</h2>
        <Button
          type="primary"
          onClick={() => this.props.history.replace('/')}
        >
          回到首页
        </Button>
      </div>
    )
  }
}
```



- 底部导航`src/components/nav-footer/nav-footer.jsx`

```jsx
/*
底部导航UI组件
*/
import React, { Component } from 'react';
import {TabBar} from 'antd-mobile'
import PropTypes from 'prop-types'
import {withRouter} from 'react-router-dom'

const Item = TabBar.Item

// 希望在非路由组件中使用路由库的api：withRouter()

class NavFooter extends Component {

  static propTypes = {
    navList: PropTypes.array.isRequired
  }

  render() {
    let {navList} = this.props
    // 过滤hide为true的nav
    navList = navList.filter(nav => !nav.hide)
    const path = this.props.location.pathname // 请求的path
    return (
      <TabBar>
        {
          navList.map((nav) => (
            <Item key={nav.path}
                  title={nav.text}
                  icon={{uri: require(`../../assets/nav/${nav.icon}.png`)}}
                  selectedIcon={{uri: require(`../../assets/nav/${nav.icon}-selected.png`)}}
                  selected={path===nav.path}
                  onPress={() => this.props.history.replace(nav.path)}
            ></Item>
          ))
        }
      </TabBar>
    )
  }
}

// 向外暴露withRouter()包装产生的组件
// 内部会向组件中传入一些路由组件特有的属性：history/location/math
export default withRouter(NavFooter) 
```



`src/redux/actions.js`

```javascript
/* 
包含n个action creator
同步action
异步action
*/
import {
  AUTH_SUCCESS,
  ERROR_MSG,
  RECEIVE_USER,
  RESET_USER
} from './action-types'
// 引入接口请求函数
import {
  reqRegister,
  reqLogin,
  reqUpdateUser,
  reqUser
} from '../api'

// 授权成功的同步action
const authSuccess = (user) => ({type: AUTH_SUCCESS, data: user})
// 错误提示信息的同步action
const errorMsg = (msg) => ({type: ERROR_MSG, data: msg}) // 或省略data
// 接收用户的同步action
const receiveUser = (user) => ({type: RECEIVE_USER, data: user})
// 重置用户的同步action
export const resetUser = (msg) => ({type: RESET_USER, data: msg})

// 注册异步action
export const register = (user) => {
  const {username, password, repassword, usertype} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }
  if(!repassword){
    return errorMsg('请输入确认密码')
  }
  if(password!==repassword){
    return errorMsg('两次输入的密码不一致，请检查！') 
    // 如果放到dispatch中应该不是return而是dispatch
  }
  // 表单数据合法，返回一个发ajax请求得异步action函数
  return async dispatch => {
    // 发送注册的异步ajax请求
    /*const promise = reqRegister(user) // 应该把repassword去掉
    promise.then(response => {
      const result = response.data // {code: 0/1, data: user, msg: ''}
    })*/
    // await等，这个函数必须声明为async
    const response = await reqRegister({username, password, usertype})
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 登录异步action
export const login = (user) => {
  const {username, password} = user
  // 前端验证，如果不通过，返回/分发一个errMsg
  if(!username){
    return errorMsg('请输入用户名')
  }
  if(!password){
    return errorMsg('请输入密码')
  }

  return async dispatch => {
    // 发送注册的异步ajax请求
    // await等，这个函数必须声明为async
    const response = await reqLogin(user)
    const result = response.data
    if(result.code===0){ // 成功
      // 分发授权成功的action
      dispatch(authSuccess(result.data))
    }else{ // 失败
      // 分发错误提示信息的action
      dispatch(errorMsg(result.msg))
    }
  }
}

// 更新用户异步action
export const updateUser = (user) => {
  return async dispath => {
    const response = await reqUpdateUser(user)
    const result = response.data
    if(result.code===0){ // 更新成功：data
      // 分发同步action
      dispath(receiveUser(result.data))
    }else{ // 更新失败：msg
      dispath(resetUser(result.msg))
    }
  }
}

// 获取用户异步action
export const getUser = () => {
  return async dispatch => {
    // 执行异步ajax请求
    const response = await reqUser()
    const result = response.data
    if(result.code===0){// 成功
      dispatch(receiveUser(result.data))
    }else{// 失败
      dispatch(resetUser(result.msg))
    }
  }
}
```





### 映射组件

`src/containers/main/main.jsx`

```jsx
/*
  主界面路由组件
*/

import React, { Component } from 'react';
import {Switch, Route, Redirect} from 'react-router-dom'
import {connect} from 'react-redux'
import Cookies from 'js-cookie' // 可以操作前端cookie的对象 set()/get()/remove()
import {NavBar} from 'antd-mobile'

import BossInfo from '../bossinfo/bossinfo'
import JobhunterInfo from '../jobhunterinfo/jobhunterinfo'
import Boss from '../boss/boss'
import Jobhunter from '../jobhunter/jobhunter'
import Message from '../message/message'
import Personal from '../personal/personal'
import NotFound from '../../components/not-found/not-found'
import NavFooter from '../../components/nav-footer/nav-footer'

import {getRedirectTo} from '../../utils'
import {getUser} from '../../redux/actions'

class Main extends Component {

  // 给组件对象添加属性
  navList = [ // 包含所有导航组件的相关信息数据
    {
      path: '/boss', // 路由路径
      component: Boss,
      title: '求职者列表',
      icon: 'home',
      text: '主页',
    },
    {
      path: '/jobhunter', // 路由路径
      component: Jobhunter,
      title: '职位列表',
      icon: 'position',
      text: '职位',
    },
    {
      path: '/message', // 路由路径
      component: Message,
      title: '消息列表',
      icon: 'message',
      text: '消息',
    },
    {
      path: '/personal', // 路由路径
      component: Personal,
      title: '用户中心',
      icon: 'personal',
      text: '个人',
    }
  ]

  componentDidMount(){
    // 如果登录过(cookie中有userid)，但现在没登录(redux管理的user中没有_id)发送请求获取对应的user
    const userid = Cookies.get('userid')
    const {_id} = this.props.user
    if(userid && !_id){
      // 发送异步请求，获取user
      this.props.getUser()
    }
  }

  render() {
    // 1读取cookie中的userid
    const userid = Cookies.get('userid')
    // 1.1如果没有，自动重定向到登录界面
    if(!userid){
      return <Redirect to='/login' />
    }
    // 1.2如果有，读取redux中的user状态
    const {user} = this.props
    // 1.2.1如果user没有_id，返回null(不做任何显示)
    // debugger // 打断，调试请求过程
    if(!user._id){
      return null
    }else{
      // 1.2.2如果有_id，显示对应的界面
      // 1.2.3访问根路径，根据user的avatar和usertype计算出一个重定向的路由路径，并自动重定向
      let path = this.props.location.pathname
      if(path==='/'){
        path = getRedirectTo(user.usertype, user.avatar)
        return <Redirect to={path} />
      }
    }

    // 确定当前所在路径，并得到对应导航信息
    const {navList} = this
    const path = this.props.location.pathname // 请求的路径
    const currentNav = navList.find(nav => nav.path===path) // 得到当前的nav，可能没有

    if(currentNav){
      // 决定哪个路由需要隐藏
      if(user.usertype==='boss'){
        // 隐藏数组的第2个
        navList[1].hide = true
      }else{
        // 隐藏数组的第1个
        navList[0].hide = true
      }
    }
    
    return (
      <div>
        {currentNav ? <NavBar>{currentNav.title}</NavBar> : null}
        <Switch>
          {
            navList.map(nav => <Route path={nav.path} component={nav.component}></Route>)
          }
          <Route path='/bossinfo' component={BossInfo}></Route>
          <Route path='/jobhunterinfo' component={JobhunterInfo}></Route>
          <Route component={NotFound} />
        </Switch>
        {currentNav ? <NavFooter navList={navList} /> : null}
      </div>
    )
  }
}

export default connect(
  state => ({user: state.user}),
  {getUser}
)(Main)
```





## 实现主界面用户列表

### 后台路由`routes/index.js`

```javascript
/* 根据类型获取用户列表 */
router.get('/userlist', function(req, res){
  const {usertype} = req.query
  UserModel.find({usertype}, filter, function (error, users){
    res.send({code: 0, dat: users})
  })
})
```



### 前台ajax `src/api/index.js`

```javascript
// 获取用户列表
export const reqUserList = (usertype) => ajax('/userlist', {usertype}, 'GET') // 默认GET，可不传第三个参数
```



### redux进行管理

- `src/redux/action-types.js`

```javascript
export const RECEIVE_USER_LIST ='receive_user_list' // 接收用户列表
```



- `src/redux/reducers.js`

```javascript
import {
  AUTH_SUCCESS,
  ERROR_MSG,
  RECEIVE_USER,
  RESET_USER,
  RECEIVE_USER_LIST
} from './action-types'

const initUserList = []
// 产生userlist状态的reducer
function userlist(state=initUserList, action){
  switch(action.type){
    case RECEIVE_USER_LIST: // data为userlist
      return action.data
    default:
      return state
  }
}

export default combineReducers({
  user,
  userList
})
// 向外暴露的状态的结构： {user: {}, userList: []}
```



- `src/redux/actions.js`

```javascript
import {
  AUTH_SUCCESS,
  ERROR_MSG,
  RECEIVE_USER,
  RESET_USER,
  RECEIVE_USER_LIST
} from './action-types'
// 引入接口请求函数
import {
  reqRegister,
  reqLogin,
  reqUpdateUser,
  reqUser,
  reqUserList
} from '../api'

// 接收用户列表的同步action
export const receiveUserList = (userList) => ({type: RECEIVE_USER_LIST, data: userList})

// 获取用户列表的异步action
export const getUserList = (usertype) => {
  return async dispatch => {
    // 执行异步ajax请求
    const response = await reqUserList(usertype)
    const result = response.data
    // 得到结果后，分发一个同步action
    if(result.code===0){
      dispatch(receiveUserList(result.data))
    }
  }
}
```





### main一级路由下的二级路由组件

- Boss主界面`src/containers/boss/boss.jsx`



- Jobhunter主界面`src/containers/jobhunter/jobhunter.jsx`
- 消息界面`src/containers/message/message.jsx`